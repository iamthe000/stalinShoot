<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>スターリンシュート-失敗政策を隠蔽せよ！</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon192x192.png">
    <link rel="icon" href="icon192x192.png">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
    <style>
        /* --- 基本設定 --- */
        html, body {
            margin: 0;
            padding: 0;
            height: auto;
        }
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            text-align: center;
            background-color: #330000;
            color: #FFDDDD;
            padding: 10px;
            box-sizing: border-box;
            min-height: 100vh;
            overflow-y: auto;
            touch-action: auto;
        }
        
        h1 {
            color: #FF5555;
            text-shadow: 2px 2px 4px #000;
            margin: 10px 0;
            font-size: 24px;
        }
        
        @media (min-width: 768px) {
            h1 {
                font-size: 32px;
            }
        }

        /* 操作説明 */
        .instructions {
            background-color: rgba(50, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin: 10px auto;
            max-width: 600px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .instructions h2 {
            color: #FF5555;
            font-size: 18px;
            margin: 0 0 10px 0;
        }
        
        .instructions ul {
            text-align: left;
            margin: 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }

        /* --- ゲームコンテナとキャンバス --- */
        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: auto;
            aspect-ratio: 4/3;
            margin: 10px auto;
        }
        canvas {
            width: 100%;
            height: 100%;
            max-height: 80vh;
            object-fit: contain;
            background-color: #660000;
            border: 3px solid #FF5555;
            display: block;
            margin: 0 auto;
            max-width: 100%;
            box-sizing: border-box;
            touch-action: none;
        }

        /* --- UI要素 --- */
        #overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: bold;
            color: #FFDDDD;
            display: none;
            background-color: rgba(50, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            box-sizing: border-box;
        }

        /* 難易度選択画面 */
        #difficulty-select {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(50, 0, 0, 0.95);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-sizing: border-box;
            display: none;
        }

        #difficulty-select h2 {
            color: #FF5555;
            font-size: 28px;
            margin: 0 0 20px 0;
        }

        .difficulty-button {
            font-size: 20px;
            padding: 15px 30px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s;
            margin: 10px;
            display: block;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .difficulty-easy {
            background-color: #00AA00;
        }

        .difficulty-easy:hover {
            background-color: #008800;
        }

        .difficulty-normal {
            background-color: #FF8800;
        }

        .difficulty-normal:hover {
            background-color: #CC6600;
        }

        .difficulty-hard {
            background-color: #CC0000;
        }

        .difficulty-hard:hover {
            background-color: #AA0000;
        }

        .difficulty-extreme {
            background-color: #990066;
        }

        .difficulty-extreme:hover {
            background-color: #660044;
        }
        
        /* 難易度ボタン内のspanのスタイル（無敵モード表示用） */
        .difficulty-button span {
            font-size: 14px;
            transition: color 0.3s;
        }

        #start-button, #bgm-toggle, #back-button {
            font-size: 20px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #CC0000;
            color: white;
            border: none;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: background-color 0.3s;
            margin: 5px;
            display: inline-block;
        }
        #start-button:hover, #back-button:hover {
            background-color: #AA0000;
        }
        #score {
            font-size: 24px;
            margin-top: 5px;
            color: #FFDDDD;
        }
        #bgm-toggle {
            background-color: #007700;
        }
        #bgm-toggle:hover {
            background-color: #005500;
        }

        /* 発射ボタン */
        #shoot-button {
            display: none;
            width: 120px;
            height: 120px;
            border-radius: 60px;
            background-color: #FF3333;
            color: white;
            border: none;
            font-size: 20px;
            margin: 20px auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            -webkit-tap-highlight-color: transparent;
        }

        #shoot-button:active {
            background-color: #CC0000;
            transform: scale(0.95);
        }

        /* スマホ表示時のみ発射ボタンを表示 */
        @media (max-width: 768px) {
            #shoot-button {
                display: block;
            }
            
            .instructions {
                font-size: 12px;
                padding: 10px;
            }
            
            .instructions h2 {
                font-size: 16px;
            }

            .difficulty-button {
                font-size: 18px;
                padding: 12px 24px;
            }

            #difficulty-select h2 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>

    <h1>スターリンシュート-失敗政策を隠蔽せよ！</h1>
    
    <div class="instructions">
        <h2>操作方法</h2>
        <ul>
            <li>PC: 左右矢印キーまたはA/Dキーで移動、スペースで発射</li>
            <li>スマートフォン: ゲーム画面をタッチ/スライドして左右移動、「発射」ボタンで発射</li>
        </ul>
        <h2>ゲーム説明</h2>
        <ul>
            <li>失敗政策を打ち消して60秒間生き残れ！</li>
            <li>政策が下に到達したり、自分に当たるとゲームオーバー</li>
            <li>60秒耐えると最終BOSSが出現！</li>
        </ul>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="overlay"></div>
        <div id="difficulty-select">
            <h2>難易度を選択せよ</h2>
            <button class="difficulty-button difficulty-easy" data-difficulty="easy">
                革命的難易度<br><span>（易しい - 敵の速度と数が控えめ）</span>
            </button>
            <button class="difficulty-button difficulty-normal" data-difficulty="normal">
                大粛清的難易度<br><span>（普通 - バランスの取れた挑戦）</span>
            </button>
            <button class="difficulty-button difficulty-hard" data-difficulty="hard">
                崩壊的難易度<br><span>（難しい - 激しい攻撃）</span>
            </button>
            <button class="difficulty-button difficulty-extreme" data-difficulty="extreme">
                8月クーデター的難易度<br><span>（超難 - 猛烈な攻撃）</span>
            </button>
            <button id="back-button">戻る</button>
        </div>
    </div>
    <button id="start-button">ゲーム開始</button>
    <button id="bgm-toggle">BGM: ON</button>
    <div id="score">耐久時間: 60.0秒</div>
    <button id="shoot-button">発射</button>

    <audio id="bgm" src="bgm.ogg" loop></audio>
    <audio id="end-bgm" src="bgm.ogg"></audio>

    <script>
        // --- 定数 ---
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 600;
        const PLAYER_WIDTH = 50;
        const PLAYER_HEIGHT = 50;
        const PLAYER_SPEED = 7;
        const BULLET_WIDTH = 5;
        const BULLET_HEIGHT = 15;
        const BULLET_SPEED = 10;
        const ENEMY_HP = 2;
        const GAME_DURATION_SEC = 60;
        const SHOOT_AREA_Y_RATIO = 0.8;

        // 難易度設定
        const DIFFICULTY_SETTINGS = {
            easy: {
                speedMin: 0.8,
                speedMax: 1.5,
                spawnInterval: 1500,
                minSpawnInterval: 800,
                maxSpawnCount: 2,
                intervalReduction: 0.6,
                bossSpeed: 2.0
            },
            normal: {
                speedMin: 1.0,
                speedMax: 2.0,
                spawnInterval: 1200,
                minSpawnInterval: 600,
                maxSpawnCount: 3,
                intervalReduction: 0.75,
                bossSpeed: 2.5
            },
            hard: {
                speedMin: 1.3,
                speedMax: 2.5,
                spawnInterval: 1500,
                minSpawnInterval: 500,
                maxSpawnCount: 3,
                intervalReduction: 0.8,
                bossSpeed: 3.0
            },
            extreme: {
                speedMin: 1.8,
                speedMax: 3.0,
                spawnInterval: 1000,
                minSpawnInterval: 450,
                maxSpawnCount: 3,
                intervalReduction: 0.8,
                bossSpeed: 5.0
            }
        };

        // --- 敵リスト ---
        const ENEMY_TEXTS = [
            "1920農業集団化", "1959七カ年計画", "1950処女地開拓運動",
            "1970中央集権計画経済", "1979アフガン侵攻", "1986チェルノブイリ",
            "1980ペレストロイカ", "1980グラスノスチ"
        ];
        const ENEMY_FONT = 'bold 18px sans-serif';
        const ENEMY_COLOR = '#FFCCCC';

        // --- ボス設定 ---
        const BOSS_TEXT = "1991ソ連崩壊";
        const BOSS_HP = 20;
        const BOSS_FONT = 'bold 60px sans-serif';
        const BOSS_COLOR = '#FFFF00';

        // --- グローバル変数 ---
        let canvas, ctx;
        let player, bullets, enemies, boss;
        let gameRunning, bossPhase;
        let keys = {};
        let lastEnemySpawnTime = 0;
        let gameStartTime;
        let playerImage;
        let bgm, endBgm;
        let animationFrameId;
        let isBgmPlaying = true;
        let currentDifficulty = 'normal';

        // ★追加: 隠しコマンド用変数
        let bgmToggleCount = 0;
        let isInvincibleMode = false;
        let gameIsInvincible = false;

        // --- スマホ操作用 ---
        let touchMode = 'none';
        let canvasRect;

        // --- DOM要素 ---
        const startButton = document.getElementById('start-button');
        const scoreDisplay = document.getElementById('score');
        const overlay = document.getElementById('overlay');
        const gameContainer = document.getElementById('game-container');
        const bgmToggle = document.getElementById('bgm-toggle');
        const difficultySelect = document.getElementById('difficulty-select');
        const backButton = document.getElementById('back-button');

        let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        let shootButton;

        // --- 初期化 ---
        window.onload = () => {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
            
            bgm = document.getElementById('bgm');
            endBgm = document.getElementById('end-bgm');
            
            playerImage = new Image();
            playerImage.src = 'player.png';
            
            playerImage.onerror = () => {
                console.warn("player.png が読み込めませんでした。代替の銀色四角形で描画します。");
            };

            scoreDisplay.textContent = `耐久時間: ${GAME_DURATION_SEC.toFixed(1)}秒`;
            startButton.addEventListener('click', showDifficultySelect);
            bgmToggle.addEventListener('click', toggleBGM);
            backButton.addEventListener('click', hideDifficultySelect);

            // 難易度ボタンのイベントリスナー
            document.querySelectorAll('.difficulty-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const difficulty = e.currentTarget.getAttribute('data-difficulty');
                    selectDifficulty(difficulty);
                });
            });

            // スマホ操作用のイベントリスナー
            setupTouchControls();

            shootButton = document.getElementById('shoot-button');
            if (isMobile) {
                shootButton.style.display = 'block';
                
                shootButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (gameRunning) shoot();
                });
            } else {
                shootButton.style.display = 'none';
            }
        };

        // --- 難易度選択画面表示 ---
        // ★修正: 隠しコマンド変数をリセット
        function showDifficultySelect() {
            difficultySelect.style.display = 'block';
            startButton.style.display = 'none';

            // 隠しコマンド関連リセット
            bgmToggleCount = 0;
            isInvincibleMode = false;
            gameIsInvincible = false;
            
            // 8月クーデターボタンのテキストを元に戻す
            const extremeButton = document.querySelector('.difficulty-extreme span');
            if (extremeButton) {
                extremeButton.textContent = '（超難 - 猛烈な攻撃）';
                extremeButton.style.color = ''; // デフォルトの色に戻す
            }
        }

        function hideDifficultySelect() {
            difficultySelect.style.display = 'none';
            startButton.style.display = 'inline-block';
        }

        // ★修正: 無敵モード判定を追加
        function selectDifficulty(difficulty) {
            currentDifficulty = difficulty;
            
            // 無敵モード判定
            if (isInvincibleMode && difficulty === 'extreme') {
                gameIsInvincible = true;
                console.log("無敵モードでゲーム開始！");
            } else {
                gameIsInvincible = false;
            }

            // コマンド関連フラグをリセット
            isInvincibleMode = false; 
            bgmToggleCount = 0;
            
            hideDifficultySelect();
            startGame();
        }

        // --- BGM ON/OFF切り替え ---
        // ★修正: 隠しコマンドのカウント処理を追加
        function toggleBGM() {
            if (isBgmPlaying) {
                bgm.pause();
                isBgmPlaying = false;
                bgmToggle.textContent = 'BGM: OFF';
            } else {
                bgm.play().catch(e => console.error("BGM再生エラー:", e)); 
                isBgmPlaying = true;
                bgmToggle.textContent = 'BGM: ON';
            }

            // 隠しコマンド判定 (難易度選択画面表示中のみ)
            if (difficultySelect.style.display === 'block') {
                bgmToggleCount++;
                console.log(`BGM Toggle Count: ${bgmToggleCount}`); // デバッグ用

                if (bgmToggleCount === 10) {
                    isInvincibleMode = true;
                    console.log("隠しコマンド成功！");
                    
                    // ユーザーに通知
                    const extremeButtonSpan = document.querySelector('.difficulty-extreme span');
                    if (extremeButtonSpan) {
                        extremeButtonSpan.textContent = '(無敵モードON)';
                        extremeButtonSpan.style.color = '#FFFF00'; // 黄色で表示
                    }
                } else if (bgmToggleCount > 10) {
                    // 10回を超えたらリセット（またはそのまま）
                    // ここでは10回達成時のみフラグを立てる
                }
            }
        }

        // --- ゲーム開始 ---
        function startGame() {
            player = {
                x: (CANVAS_WIDTH - PLAYER_WIDTH) / 2,
                y: CANVAS_HEIGHT - PLAYER_HEIGHT - 10,
                width: PLAYER_WIDTH,
                height: PLAYER_HEIGHT,
                speed: PLAYER_SPEED
                // gameIsInvincible はグローバル変数を使用
            };
            bullets = [];
            enemies = [];
            boss = null;
            gameRunning = true;
            bossPhase = false;
            lastEnemySpawnTime = 0;
            gameStartTime = Date.now();
            keys = {};
            touchMode = 'none';
            scoreDisplay.textContent = `耐久時間: ${GAME_DURATION_SEC.toFixed(1)}秒`;
            overlay.style.display = 'none';
            startButton.style.display = 'inline-block';

            if (isMobile) {
                shootButton.style.display = 'block';
            }

            endBgm.pause();
            endBgm.currentTime = 0;
            
            if (isBgmPlaying) {
                bgm.currentTime = 0;
                bgm.play().catch(e => console.error("BGM再生エラー:", e));
            }

            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);

            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            gameLoop(0);
        }

        // --- キー入力ハンドラ ---
        function handleKeyDown(e) {
            keys[e.code] = true;
            if (e.code === 'Space' && gameRunning) {
                e.preventDefault();
                shoot();
            }
        }
        function handleKeyUp(e) {
            keys[e.code] = false;
        }

        // --- スマホ操作ハンドラ ---
        function setupTouchControls() {
            canvasRect = canvas.getBoundingClientRect();
            window.addEventListener('resize', () => {
                canvasRect = canvas.getBoundingClientRect();
            });

            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
        }

        function handleTouchStart(e) {
            if (!gameRunning) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            
            canvasRect = canvas.getBoundingClientRect();
            const scaleX = CANVAS_WIDTH / canvasRect.width;
            const relativeX = touch.clientX - canvasRect.left;
            const internalX = relativeX * scaleX;

            touchMode = 'move';
            updatePlayerPosition(internalX);
        }

        function handleTouchMove(e) {
            if (!gameRunning || touchMode !== 'move') return;
            e.preventDefault();
            
            const touch = e.touches[0];
            
            canvasRect = canvas.getBoundingClientRect();
            const scaleX = CANVAS_WIDTH / canvasRect.width;
            const relativeX = touch.clientX - canvasRect.left;
            const internalX = relativeX * scaleX;
            
            updatePlayerPosition(internalX);
        }

        function handleTouchEnd(e) {
            if (!gameRunning) return;
            e.preventDefault();
            touchMode = 'none';
        }

        function updatePlayerPosition(internalX) {
            player.x = internalX - player.width / 2;
            if (player.x < 0) player.x = 0;
            if (player.x > CANVAS_WIDTH - player.width) {
                player.x = CANVAS_WIDTH - player.width;
            }
        }

        // --- 弾発射 ---
        function shoot() {
            const bullet = {
                x: player.x + (PLAYER_WIDTH - BULLET_WIDTH) / 2,
                y: player.y,
                width: BULLET_WIDTH,
                height: BULLET_HEIGHT,
                speed: BULLET_SPEED
            };
            bullets.push(bullet);
        }

        // --- 敵生成 ---
        function spawnEnemy() {
            const settings = DIFFICULTY_SETTINGS[currentDifficulty];
            const text = ENEMY_TEXTS[Math.floor(Math.random() * ENEMY_TEXTS.length)];
            ctx.font = ENEMY_FONT;
            const textMetrics = ctx.measureText(text);
            const textWidth = textMetrics.width;
            const textHeight = 18;
            
            const enemy = {
                x: Math.random() * Math.max(0, CANVAS_WIDTH - textWidth),
                y: -textHeight,
                text: text,
                speed: settings.speedMin + Math.random() * (settings.speedMax - settings.speedMin),
                width: textWidth,
                height: textHeight,
                maxHp: ENEMY_HP,
                hp: ENEMY_HP
            };
            enemies.push(enemy);
        }

        function spawnEnemies(count) {
            for (let i = 0; i < count; i++) {
                spawnEnemy();
            }
        }

        // --- 更新処理 (メイン) ---
        function update(timestamp) {
            if (!gameRunning) return;

            // プレイヤー移動 (キーボード)
            if (keys['ArrowLeft'] || keys['KeyA']) {
                player.x -= player.speed;
                if (player.x < 0) player.x = 0;
            }
            if (keys['ArrowRight'] || keys['KeyD']) {
                player.x += player.speed;
                if (player.x > CANVAS_WIDTH - player.width) {
                    player.x = CANVAS_WIDTH - player.width;
                }
            }

            updateBullets();

            if (bossPhase) {
                updateBoss();
            } else {
                updateEnemies(timestamp);
                updateTimer();
            }
        }
        
        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].y -= bullets[i].speed;
                if (bullets[i].y < -BULLET_HEIGHT) {
                    bullets.splice(i, 1);
                }
            }
        }

        // ★修正: 無敵判定を追加
        function updateEnemies(timestamp) {
            // 通常時の雑魚敵更新
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                enemy.y += enemy.speed;

                if (enemy.y > CANVAS_HEIGHT) {
                    gameOver("失敗！ 政策が露見した！");
                    return;
                }
                
                // ★無敵判定
                if (!gameIsInvincible && checkCollision(player, enemy)) {
                    gameOver("失敗！ 責任を問われた！");
                    return;
                }

                for (let j = bullets.length - 1; j >= 0; j--) {
                    if (checkCollision(bullets[j], enemy)) {
                        bullets.splice(j, 1);
                        enemy.hp--;
                        if (enemy.hp <= 0) {
                            enemies.splice(i, 1);
                        }
                        break; 
                    }
                }
            }

            // 通常時の敵生成ロジック
            if (!bossPhase) {
                const settings = DIFFICULTY_SETTINGS[currentDifficulty];
                const elapsedSec = (Date.now() - gameStartTime) / 1000;
                const progress = Math.min(1, elapsedSec / GAME_DURATION_SEC);
                const spawnInterval = Math.max(
                    settings.minSpawnInterval, 
                    settings.spawnInterval * (1 - settings.intervalReduction * progress)
                );
                const spawnCount = 1 + Math.floor(progress * (settings.maxSpawnCount - 1));

                if (timestamp - lastEnemySpawnTime > spawnInterval) {
                    spawnEnemies(spawnCount);
                    lastEnemySpawnTime = timestamp;
                }
            }
        }

        function updateTimer() {
            const elapsedTime = (Date.now() - gameStartTime) / 1000;
            const remainingTime = Math.max(0, GAME_DURATION_SEC - elapsedTime);
            scoreDisplay.textContent = `耐久時間: ${remainingTime.toFixed(1)}秒`;

            if (remainingTime <= 0) {
                enterBossPhase();
            }
        }

        function enterBossPhase() {
            bossPhase = true;
            enemies = []; // 通常の敵をクリア
            scoreDisplay.textContent = "ラスボス出現！";
            
            const settings = DIFFICULTY_SETTINGS[currentDifficulty];
            ctx.font = BOSS_FONT;
            const metrics = ctx.measureText(BOSS_TEXT);
            boss = {
                text: BOSS_TEXT,
                x: (CANVAS_WIDTH - metrics.width) / 2,
                y: 100,
                width: metrics.width,
                height: 60,
                hp: BOSS_HP,
                maxHp: BOSS_HP,
                speedX: settings.bossSpeed
            };
            scoreDisplay.textContent = `ボスHP: ${boss.hp}`;
        }

        // ★修正: 無敵判定を追加
        function updateBoss() {
            if (!boss) return;

            // ボス本体の移動
            boss.x += boss.speedX;
            if (boss.x < 0 || boss.x + boss.width > CANVAS_WIDTH) {
                boss.speedX *= -1;
                boss.x = Math.max(0, Math.min(boss.x, CANVAS_WIDTH - boss.width));
            }

            // ボスが生存中、ランダムに「共和国離反」を生成
            if (Math.random() < 0.03) { // 3%の確率で生成
                const text = "共和国離反";
                ctx.font = ENEMY_FONT;
                const metrics = ctx.measureText(text);
                const enemy = {
                    x: Math.random() * (CANVAS_WIDTH - metrics.width),
                    y: -30,
                    text: text,
                    speed: 3,
                    width: metrics.width,
                    height: 18,
                    maxHp: 1,
                    hp: 1
                };
                enemies.push(enemy); // enemies 配列に追加
            }

            // ボスフェーズ中の雑魚敵（共和国離反）の更新処理
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                enemy.y += enemy.speed;
                if (enemy.y > CANVAS_HEIGHT) {
                    gameOver("失敗！ 政策が露見した！");
                    return;
                }
                
                // ★無敵判定
                if (!gameIsInvincible && checkCollision(player, enemy)) {
                    gameOver("失敗！ 責任を問われた！");
                    return;
                }
                
                for (let j = bullets.length - 1; j >= 0; j--) {
                    if (checkCollision(bullets[j], enemy)) {
                        bullets.splice(j, 1);
                        enemy.hp--;
                        if (enemy.hp <= 0) {
                            enemies.splice(i, 1);
                        }
                        break;
                    }
                }
            }

            // ボスとプレイヤーの当たり判定
            // ★無敵判定
            if (!gameIsInvincible && checkCollision(player, boss)) {
                gameOver("失敗！ 崩壊に巻き込まれた！");
                return;
            }

            // ボスと弾の当たり判定
            for (let j = bullets.length - 1; j >= 0; j--) {
                if (checkCollision(bullets[j], boss)) {
                    bullets.splice(j, 1);
                    boss.hp--;
                    
                    if (boss.hp <= 0) {
                        scoreDisplay.textContent = "ボスHP: 0";
                        gameWin("勝利！ 歴史を改変した！");
                        return;
                    }
                    scoreDisplay.textContent = `ボスHP: ${boss.hp}`;
                    break;
                }
            }
        }
        
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // --- 描画処理 ---
        // ★修正: 無敵モード中のプレイヤー描画（点滅）を追加
        function draw() {
            ctx.fillStyle = '#660000';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // プレイヤー描画
            let drawPlayer = true;
            if (gameIsInvincible && Math.floor(Date.now() / 150) % 2 === 0) {
                 drawPlayer = false; // 無敵時点滅
            }

            if (drawPlayer) {
                if (playerImage.complete && playerImage.naturalWidth !== 0) {
                    ctx.drawImage(playerImage, player.x, player.y, player.width, player.height);
                } else {
                    // 画像がない場合の代替描画（無敵時は黄色、通常時銀色）
                    ctx.fillStyle = gameIsInvincible ? '#FFFF00' : 'silver';
                    ctx.fillRect(player.x, player.y, player.width, player.height);
                }
            } else if (!playerImage.complete || playerImage.naturalWidth === 0) {
                // 画像がなく、点滅で非表示の場合の代替（背景色で塗りつぶし）
                // ※画像がある場合は drawPlayer が false の時点で描画がスキップされる
                // ※ただし、代替描画が黄色の場合、非表示にするために背景色で塗る必要はない
                //    （drawPlayer=falseの時点で描画がスキップされるため）
                //    このロジックは画像ありの場合と統一
            }


            // 弾描画
            ctx.fillStyle = '#FFFF00';
            for (const bullet of bullets) {
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            }

            // 雑魚敵の描画 (通常時もボスフェーズ時も実行)
            ctx.fillStyle = ENEMY_COLOR;
            ctx.font = ENEMY_FONT;
            ctx.textBaseline = 'top';
            for (const enemy of enemies) {
                ctx.fillText(enemy.text, enemy.x, enemy.y);
                const barW = Math.max(30, enemy.width);
                const barH = 6;
                let barX = enemy.x;
                let barY = enemy.y - barH - 6;
                if (barY < 0) barY = enemy.y + enemy.height + 4;
                ctx.fillStyle = '#330000';
                ctx.fillRect(barX, barY, barW, barH);
                const ratio = Math.max(0, enemy.hp / enemy.maxHp);
                ctx.fillStyle = '#55FF55';
                ctx.fillRect(barX, barY, barW * ratio, barH);
                ctx.strokeStyle = '#000';
                ctx.strokeRect(barX, barY, barW, barH);
            }

            // ボスの描画 (ボスフェーズ中のみ実行)
            if (bossPhase && boss) {
                ctx.fillStyle = BOSS_COLOR;
                ctx.font = BOSS_FONT;
                ctx.textBaseline = 'top';
                ctx.fillText(boss.text, boss.x, boss.y);
                const bossBarW = boss.width;
                const bossBarH = 12;
                const bossBarX = boss.x;
                let bossBarY = boss.y - bossBarH - 8;
                if (bossBarY < 0) bossBarY = boss.y + boss.height + 8;
                ctx.fillStyle = '#330000';
                ctx.fillRect(bossBarX, bossBarY, bossBarW, bossBarH);
                const bossRatio = Math.max(0, boss.hp / boss.maxHp);
                ctx.fillStyle = '#55FF55';
                ctx.fillRect(bossBarX, bossBarY, bossBarW * bossRatio, bossBarH);
                ctx.strokeStyle = '#000';
                ctx.strokeRect(bossBarX, bossBarY, bossBarW, bossBarH);
            }
        }

        // --- メインループ ---
        function gameLoop(timestamp) {
            if (!gameRunning) return; 

            update(timestamp);
            draw();

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // --- ゲームオーバー / クリア処理 ---
        function stopGame() {
            gameRunning = false;
            cancelAnimationFrame(animationFrameId);
            bgm.pause();
            endBgm.currentTime = 0;
            endBgm.play().catch(e => console.error("終了BGM再生エラー:", e));
            
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);

            if (isMobile) {
                shootButton.style.display = 'none';
            }
        }

        function gameOver(message) {
            stopGame();
            overlay.textContent = message;
            overlay.style.color = '#FF5555';
            overlay.style.display = 'block';
            startButton.textContent = 'リトライ';
        }

        function gameWin(message) {
            stopGame();
            overlay.textContent = message;
            overlay.style.color = '#55FF55';
            overlay.style.display = 'block';
            startButton.textContent = 'もう一度プレイ';
        }

    </script>

</body>
</html>
